<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Edit Article</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body{font-family:Arial;background:#f6f6f6}
#box{background:white;padding:20px}
textarea{width:100%;height:300px}
button{padding:8px 14px}
</style>
</head>

<body>

<div id="box">
  <h2 id="title"></h2>
  <textarea id="content"></textarea><br>
  <button onclick="save()">Save</button>
  <button onclick="cancel()">Cancel</button>
</div>

<script>
const SUPABASE_URL="https://xoxnnfdchijdvdyrfbek.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhveG5uZmRjaGlqZHZkeXJmYmVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MDU4MzAsImV4cCI6MjA4MDk4MTgzMH0.3AlIWOPTDPVopMtdc2orgmSvEtBGAtO7aXQpVpeOCLU";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

function param(x){ return new URLSearchParams(location.search).get(x); }

const page = param("page");

if(!page){
  alert("No article specified");
  location.href="index.html";
}

const title = document.getElementById("title");
const content = document.getElementById("content");

async function load(){
 const {data}=await sb.from("pages").select("*").eq("title",page).single();
 if(data.locked === true){
  alert("This page is locked and cannot be edited.");
  location.href="index.html?page="+encodeURIComponent(page);
  return;
}
 if(!data){
   alert("Article does not exist");
   location.href="index.html";
   return;
 }
 title.innerText=data.title;
 content.value=data.content||"";
}
load();

async function save(){
 const text=content.value;
 const now=new Date();

 await sb.from("pages").update({content:text,updated:now}).eq("title",page);

 const {data}=await sb.from("pages").select("*").eq("title",page).single();
 if(data) await sb.from("edits").insert({page_id:data.id,content:text});

 location.href="index.html?page="+encodeURIComponent(page);
}

function cancel(){
 location.href="index.html?page="+encodeURIComponent(page);
}
</script>

</body>
</html>
