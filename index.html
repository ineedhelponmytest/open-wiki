<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OpenWiki</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body{font-family:Arial;margin:0;background:#f6f6f6}
#top{background:white;padding:12px;border-bottom:1px solid #ccc}
#content{background:white;padding:22px}
#view{margin-top:10px}
button{padding:6px 12px}
</style>
</head>

<body>

<div id="top">
  <b>OpenWiki</b>
  <button id="editBtn" style="float:right;display:none" onclick="editPage()">Edit</button>
</div>

<div id="content">
  <h1 id="title"></h1>
  <div id="view"></div>
</div>

<script>
// ===== CONFIG =====
const SUPABASE_URL = "https://xoxnnfdchijdvdyrfbek.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhveG5uZmRjaGlqZHZkeXJmYmVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MDU4MzAsImV4cCI6MjA4MDk4MTgzMH0.3AlIWOPTDPVopMtdc2orgmSvEtBGAtO7aXQpVpeOCLU";
// =================

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function safe(t){ const d=document.createElement("div"); d.innerText=t||""; return d.innerHTML; }
function param(name){ return new URLSearchParams(location.search).get(name); }

const pageTitle = param("page");
if(!pageTitle){
  document.body.innerHTML = "<h2>No page specified</h2>";
  throw "";
}

async function load(){
  const { data } = await sb.from("pages").select("*").eq("title",pageTitle).single();

  // Page does not exist â†’ redirect to edit
  if(!data){
    location.href = "edit.html?page=" + encodeURIComponent(pageTitle);
    return;
  }

  document.getElementById("title").innerText = data.title;
  document.getElementById("view").innerHTML = render(data.content);
  document.getElementById("editBtn").style.display = "inline";
}

function editPage(){
  location.href = "edit.html?page=" + encodeURIComponent(pageTitle);
}

function render(text){
  return safe(text||"")
    .replace(/^==(.+?)==$/gm,"<h2>$1</h2>")
    .replace(/^===(.+?)===$/gm,"<h3>$1</h3>")
    .replace(/\*\*(.+?)\*\*/g,"<b>$1</b>")
    .replace(/\n/g,"<br>");
}

load();
</script>

</body>
</html>
